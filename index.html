<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Admin Rewards</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Animasi kustom Tailwind */
        @keyframes pulse-custom {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        .animate-pulse-custom {
            animation: pulse-custom 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Sembunyikan panah input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen p-3 md:p-8">

    <!-- HEADER -->
    <header class="mb-6 md:mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <div class="flex items-center gap-2 md:gap-3 mb-2">
                <i data-lucide="activity" class="w-6 h-6 md:w-8 md:h-8 text-blue-600"></i>
                <h1 class="text-xl md:text-3xl font-bold text-slate-900">Sistem Pemantauan Poin</h1>
            </div>
            <div class="flex items-center gap-2 text-sm md:text-base text-slate-500">
                <span>Admin Aktif:</span>
                <div id="admin-display-container" class="flex items-center">
                    <span id="current-admin-text" class="font-medium text-slate-700 cursor-pointer border-b border-dashed border-slate-400 hover:text-blue-600 hover:border-blue-600 transition-colors" title="Klik untuk mengubah nama admin">Admin Utama</span>
                </div>
                <div id="admin-edit-container" class="hidden items-center gap-1">
                    <input type="text" id="admin-input" class="px-2 py-0.5 border border-blue-300 rounded text-slate-800 outline-none w-32 md:w-48 bg-white text-sm">
                    <button id="save-admin-btn" class="p-1 text-emerald-600 hover:bg-emerald-50 rounded"><i data-lucide="check" class="w-4 h-4"></i></button>
                    <button id="cancel-admin-btn" class="p-1 text-slate-400 hover:bg-slate-100 rounded"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>
        
        <!-- Tombol Backup & Recovery -->
        <div class="flex items-center gap-2 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
            <i data-lucide="database" class="w-5 h-5 text-slate-400 mx-2 hidden md:block"></i>
            <button id="backup-btn" class="flex flex-1 items-center justify-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-lg transition-colors">
                <i data-lucide="download" class="w-4 h-4"></i> Backup
            </button>
            <input type="file" accept=".json" id="file-upload" class="hidden">
            <label for="file-upload" class="flex flex-1 items-center justify-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-900 text-white text-sm font-medium rounded-lg transition-colors cursor-pointer mb-0">
                <i data-lucide="upload" class="w-4 h-4"></i> Pulihkan
            </label>
        </div>
    </header>

    <div class="flex flex-col gap-6 md:gap-8">
        <!-- DAFTAR PENGGUNA -->
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 md:p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h2 class="text-base md:text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="users" class="w-4 h-4 md:w-5 md:h-5 text-blue-500"></i> Daftar Akun
                    </h2>
                    <div class="flex items-center gap-2">
                        <button id="toggle-manage-btn" class="p-1.5 md:p-2 rounded-lg transition-colors border shadow-sm flex items-center justify-center bg-white text-slate-600 hover:bg-slate-50 border-slate-200" title="Buka Mode Pengaturan">
                            <i data-lucide="settings" class="w-4 h-4"></i>
                        </button>
                        <button id="add-user-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs md:text-sm font-medium rounded-lg transition-colors flex items-center gap-1.5 shadow-sm">
                            <i data-lucide="user-plus" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
                            <span class="hidden sm:inline">Tambah Akun</span>
                            <span class="sm:hidden">Tambah</span>
                        </button>
                    </div>
                </div>
                <div id="users-container" class="divide-y divide-slate-100">
                    <!-- Data Pengguna Dimuat Di Sini -->
                </div>
            </div>
        </div>

        <!-- LOG AKTIVITAS -->
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 md:p-5 border-b border-slate-100 bg-slate-50/50">
                    <h2 class="text-base md:text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="history" class="w-4 h-4 md:w-5 md:h-5 text-emerald-500"></i> Log Aktivitas
                    </h2>
                    <p class="text-[10px] md:text-xs text-slate-500 mt-1">Mencatat aktivitas dan perubahan poin.</p>
                </div>
                <div class="p-0">
                    <ul id="logs-container" class="divide-y divide-slate-100">
                        <!-- Log Aktivitas Dimuat Di Sini -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PENGATURAN AKUN (EDIT) -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden m-2">
            <div class="p-4 md:p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-base md:text-lg font-semibold text-slate-900 flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-slate-500"></i> Pengaturan Akun
                </h3>
                <button id="close-edit-modal" class="text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-4 md:p-5 space-y-3 md:space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Nama Pengguna</label>
                    <input type="text" id="edit-name" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="edit-email" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                </div>
                <div class="grid grid-cols-2 gap-3 md:gap-4">
                    <div>
                        <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Poin</label>
                        <input type="number" id="edit-points" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition-all bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Total Bonus</label>
                        <input type="number" id="edit-bonus" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-all bg-amber-50">
                    </div>
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Peran</label>
                    <input type="text" id="edit-role" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all bg-white" placeholder="Misal: VIP, Moderator...">
                </div>
            </div>
            <div class="p-4 md:p-5 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
                <button id="delete-user-trigger" class="px-3 py-2 text-sm md:text-base text-red-600 hover:bg-red-50 rounded-lg transition-colors font-medium flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> <span class="hidden sm:inline">Hapus Akun</span>
                </button>
                <div class="flex gap-2 md:gap-3">
                    <button id="cancel-edit-modal" class="px-3 md:px-4 py-2 text-sm md:text-base text-slate-600 hover:bg-slate-200 rounded-lg transition-colors font-medium">Batal</button>
                    <button id="save-edit-modal" class="px-3 md:px-4 py-2 text-sm md:text-base bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium flex items-center gap-2 shadow-sm">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL TAMBAH AKUN -->
    <div id="add-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden m-2">
            <div class="p-4 md:p-5 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-base md:text-lg font-semibold text-slate-900">Tambah Akun Baru</h3>
                <button id="close-add-modal" class="text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-4 md:p-5 space-y-3 md:space-y-4">
                <div>
                    <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Nama Pengguna</label>
                    <input type="text" id="add-name" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="Masukkan nama lengkap...">
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="add-email" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="email@contoh.com">
                </div>
                <div class="grid grid-cols-2 gap-3 md:gap-4">
                    <div>
                        <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Poin Awal</label>
                        <input type="number" id="add-points" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Bonus Awal</label>
                        <input type="number" id="add-bonus" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-all" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-slate-700 mb-1">Peran</label>
                    <input type="text" id="add-role" class="w-full p-2.5 md:p-3 text-sm md:text-base border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="Misal: VIP...">
                </div>
            </div>
            <div class="p-4 md:p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-2 md:gap-3">
                <button id="cancel-add-modal" class="px-3 md:px-4 py-2 text-sm md:text-base text-slate-600 hover:bg-slate-200 rounded-lg transition-colors font-medium">Batal</button>
                <button id="save-add-modal" class="px-3 md:px-4 py-2 text-sm md:text-base bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium flex items-center gap-2 shadow-sm">
                    <i data-lucide="user-plus" class="w-4 h-4"></i> Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL KONFIRMASI HAPUS -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm overflow-hidden m-2">
            <div class="p-4 md:p-5 border-b border-slate-100 flex items-center gap-3 text-red-600">
                <i data-lucide="alert-triangle" class="w-5 h-5 md:w-6 md:h-6"></i>
                <h3 class="text-base md:text-lg font-semibold text-slate-900">Hapus Akun?</h3>
            </div>
            <div class="p-4 md:p-5">
                <p class="text-sm md:text-base text-slate-600 mb-2">Apakah Anda yakin ingin menghapus akun <strong id="delete-user-name" class="text-slate-900"></strong>?</p>
                <p class="text-xs md:text-sm text-slate-500">Tindakan ini tidak dapat dibatalkan dan semua data poin akan terhapus secara permanen.</p>
            </div>
            <div class="p-4 md:p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-2 md:gap-3">
                <button id="cancel-delete-modal" class="px-3 md:px-4 py-2 text-sm md:text-base text-slate-600 hover:bg-slate-200 rounded-lg transition-colors font-medium">Batal</button>
                <button id="confirm-delete-btn" class="px-3 md:px-4 py-2 text-sm md:text-base bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-medium flex items-center gap-2 shadow-sm">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Hapus
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase dan Logika Aplikasi -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Cek Keberadaan Konfigurasi Cloud Bawaan
        const isFirebaseConfigProvided = typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== '';
        
        // State Aplikasi
        let users = [
            { id: 1, name: 'Budi Santoso', email: 'budi@example.com', points: 1500, bonus: 500, role: 'Pengguna' },
            { id: 4, name: 'Admin Utama', email: 'admin@rewards.local', points: 99999, bonus: 0, role: 'Admin' }
        ];
        let logs = [
            { id: 101, timestamp: new Date().toLocaleString('id-ID'), admin: 'Sistem', targetUser: 'Sistem', action: 'Inisialisasi data awal', oldPoints: 0, newPoints: 0 }
        ];
        let currentAdmin = "Admin Utama";
        let isManageMode = false;
        
        let db = null;
        let firebaseUser = null;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let userToDeleteId = null;

        // State Inline Edit
        let inlinePointEditId = null;
        let inlinePointEditValue = "";
        let inlineBonusEditId = null;
        let inlineBonusEditValue = "";

        // Referensi Drag & Drop
        let dragItemIndex = null;
        let dragOverItemIndex = null;

        // Inisialisasi Firebase HANYA JIKA konfigurasi ada
        if (isFirebaseConfigProvided) {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();

                onAuthStateChanged(auth, (user) => {
                    firebaseUser = user;
                    if (user) {
                        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'dashboard', 'data');
                        onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                users = data.users || [];
                                logs = data.logs || [];
                                currentAdmin = data.currentAdmin || "Admin Utama";
                            } else {
                                setDoc(docRef, { users, logs, currentAdmin }).catch(console.error);
                            }
                            renderApp();
                        }, (error) => {
                            console.error("Gagal terhubung ke penyimpanan:", error);
                        });
                    }
                });
            } catch (error) {
                console.error("Konfigurasi Firebase tidak valid. Berjalan di Mode Lokal.");
            }
        }

        // Fungsi update data
        const updateData = (newUsers, newLogs, newAdmin) => {
            users = newUsers;
            logs = newLogs;
            if (newAdmin) currentAdmin = newAdmin;
            
            // Langsung Render layarnya agar responsif (instan)
            renderApp();
            
            // Lakukan sinkronisasi data ke Cloud jika terhubung
            if (isFirebaseConfigProvided && firebaseUser && db) {
                const docRef = doc(db, 'artifacts', appId, 'users', firebaseUser.uid, 'dashboard', 'data');
                setDoc(docRef, { users, logs, currentAdmin }).catch(console.error);
            }
        };

        // Render UI Utama
        function renderApp() {
            renderHeader();
            renderUsers();
            renderLogs();
            lucide.createIcons(); // Memuat ikon baru setiap kali HTML di-refresh
        }

        function renderHeader() {
            document.getElementById('current-admin-text').textContent = currentAdmin;
            const btn = document.getElementById('toggle-manage-btn');
            if (isManageMode) {
                btn.className = "p-1.5 md:p-2 rounded-lg transition-colors border shadow-sm flex items-center justify-center bg-slate-700 text-white border-slate-700";
            } else {
                btn.className = "p-1.5 md:p-2 rounded-lg transition-colors border shadow-sm flex items-center justify-center bg-white text-slate-600 hover:bg-slate-50 border-slate-200";
            }
        }

        function renderUsers() {
            const container = document.getElementById('users-container');
            container.innerHTML = '';
            
            users.forEach((user, index) => {
                const isEditedToday = user.editedDate === new Date().toDateString();
                const editCount = isEditedToday ? (user.editCountToday || 1) : 0;
                
                let rowBgClass = 'hover:bg-slate-50 border-l-4 border-transparent';
                let isHighPoints = user.points >= 8000;

                if (isHighPoints) {
                    rowBgClass = 'bg-orange-100 hover:bg-orange-200 border-l-4 border-l-red-600 animate-pulse-custom shadow-inner relative z-10';
                } else if (editCount === 1) {
                    rowBgClass = 'bg-emerald-100 hover:bg-emerald-200 border-l-4 border-transparent';
                } else if (editCount === 2) {
                    rowBgClass = 'bg-blue-100 hover:bg-blue-200 border-l-4 border-transparent';
                } else if (editCount === 3) {
                    rowBgClass = 'bg-amber-100 hover:bg-amber-200 border-l-4 border-transparent';
                } else if (editCount >= 4) {
                    rowBgClass = 'bg-rose-100 hover:bg-rose-200 border-l-4 border-transparent';
                }

                const roleIsAdmin = (user.role || '').toLowerCase().includes('admin');
                const roleClass = roleIsAdmin ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';

                const row = document.createElement('div');
                row.className = `p-4 transition-all flex items-center justify-between gap-3 md:gap-4 group cursor-grab active:cursor-grabbing ${rowBgClass}`;
                row.draggable = true;
                row.dataset.index = index;
                row.title = isHighPoints ? "Pencapaian Poin Tinggi!" : "Klik dan tahan untuk menggeser posisi";

                // Event Listener Drag & Drop
                row.addEventListener('dragstart', (e) => { dragItemIndex = index; });
                row.addEventListener('dragenter', (e) => { dragOverItemIndex = index; });
                row.addEventListener('dragover', (e) => { e.preventDefault(); });
                row.addEventListener('dragend', handleSort);

                let bonusHTML = '';
                if (inlineBonusEditId === user.id) {
                    bonusHTML = `
                        <div class="flex items-center gap-1 bg-white border border-amber-300 rounded-md p-0.5 shadow-sm" onclick="event.stopPropagation()">
                            <input type="number" id="inline-bonus-input-${user.id}" value="${inlineBonusEditValue}" class="w-16 md:w-20 text-xs text-right outline-none font-semibold text-slate-700 bg-transparent">
                            <button onclick="event.stopPropagation(); saveInlineBonus(${user.id})" class="p-0.5 text-emerald-600 hover:bg-emerald-50 rounded"><i data-lucide="check" class="w-3 h-3"></i></button>
                            <button onclick="event.stopPropagation(); cancelInlineBonus()" class="p-0.5 text-slate-400 hover:bg-slate-100 rounded"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>`;
                } else if (user.bonus && user.bonus > 0) {
                    bonusHTML = `
                        <span onclick="event.stopPropagation(); openInlineBonus(${user.id}, ${user.bonus})" class="cursor-pointer px-2 py-0.5 rounded-full text-[10px] md:text-xs font-medium shrink-0 bg-amber-100 text-amber-700 hover:bg-amber-200 transition-colors border border-amber-200" title="Klik untuk mengubah total bonus">
                            ${user.bonus.toLocaleString('id-ID')}
                        </span>`;
                }

                let pointsHTML = '';
                if (inlinePointEditId === user.id) {
                    pointsHTML = `
                        <div class="flex items-center gap-1 bg-white border border-blue-300 rounded-md p-1 shadow-sm absolute right-0 top-1/2 -translate-y-1/2 z-10">
                            <input type="number" id="inline-point-input-${user.id}" value="${inlinePointEditValue}" class="w-16 md:w-24 text-sm md:text-base text-right outline-none font-semibold text-slate-700 bg-transparent">
                            <button onclick="saveInlinePoints(${user.id})" class="p-1 text-emerald-600 hover:bg-emerald-50 rounded"><i data-lucide="check" class="w-4 h-4"></i></button>
                            <button onclick="cancelInlinePoints()" class="p-1 text-slate-400 hover:bg-slate-100 rounded"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>`;
                }

                row.innerHTML = `
                    <div class="flex items-center justify-center w-6 h-6 md:w-8 md:h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs md:text-sm group-hover:bg-blue-100 group-hover:text-blue-700 cursor-grab active:cursor-grabbing flex-shrink-0 transition-colors">
                        ${index + 1}
                    </div>
                    <div class="flex-1 min-w-0 cursor-pointer p-1.5 -m-1.5 rounded-lg hover:bg-slate-100 border border-transparent hover:border-slate-200 transition-colors" onclick="openEditModal(${user.id})" title="Klik untuk mengedit profil akun">
                        <div class="flex flex-wrap items-center gap-2 mb-0.5 md:mb-1">
                            <p class="font-medium text-slate-900 truncate text-sm md:text-base">${user.name}</p>
                            <span class="px-2 py-0.5 rounded-full text-[10px] md:text-xs font-medium shrink-0 ${roleClass}">${user.role || 'Pengguna'}</span>
                            ${bonusHTML}
                        </div>
                        <p class="text-xs md:text-sm text-slate-500 truncate">${user.email}</p>
                    </div>
                    <div class="flex items-center gap-4 md:gap-6 shrink-0">
                        <div class="text-right relative">
                            ${pointsHTML}
                            <div onclick="openInlinePoints(${user.id}, ${user.points})" class="cursor-pointer p-1.5 -m-1.5 rounded-lg hover:bg-red-50 border border-transparent transition-colors ${inlinePointEditId === user.id ? 'invisible' : ''}" title="${isHighPoints ? 'Pencapaian Poin Tinggi! Klik untuk mengubah' : 'Klik untuk mengubah poin'}">
                                <p class="text-[10px] md:hidden font-medium uppercase tracking-wider mb-0.5 ${isHighPoints ? 'text-red-400' : 'text-slate-400'}">Poin</p>
                                <p class="${isHighPoints ? 'text-red-600 font-black text-lg md:text-xl drop-shadow-md' : 'font-semibold text-slate-700 text-sm md:text-base'}">
                                    ${user.points.toLocaleString('id-ID')}
                                </p>
                            </div>
                        </div>
                        ${isManageMode ? `
                        <div class="flex border-l border-slate-200 pl-4 md:pl-6">
                            <button onclick="event.stopPropagation(); openEditModal(${user.id})" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors bg-slate-50 md:bg-transparent border border-slate-100 md:border-transparent" title="Edit Akun">
                                <i data-lucide="edit-2" class="w-4 h-4 md:w-5 md:h-5"></i>
                            </button>
                        </div>` : ''}
                    </div>
                `;
                container.appendChild(row);

                // Auto-fokus untuk edit cepat
                if (inlinePointEditId === user.id) {
                    setTimeout(() => document.getElementById(`inline-point-input-${user.id}`).focus(), 0);
                }
                if (inlineBonusEditId === user.id) {
                    setTimeout(() => document.getElementById(`inline-bonus-input-${user.id}`).focus(), 0);
                }
            });
        }

        function renderLogs() {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-slate-500 flex flex-col items-center">
                        <i data-lucide="alert-circle" class="w-8 h-8 mb-2 opacity-50"></i>
                        <p>Belum ada aktivitas terekam.</p>
                    </div>`;
                return;
            }

            logs.forEach(log => {
                const li = document.createElement('li');
                li.className = "p-4 hover:bg-slate-50 transition-colors";
                
                let pointsChange = '';
                if (log.oldPoints !== 0 || log.newPoints !== 0) {
                    pointsChange = `
                        <div class="flex items-center gap-2 text-[10px] md:text-xs font-medium">
                            <span class="px-2 py-1 bg-red-50 text-red-600 rounded">${log.oldPoints.toLocaleString('id-ID')}</span>
                            <span class="text-slate-400">â†’</span>
                            <span class="px-2 py-1 bg-emerald-50 text-emerald-600 rounded">${log.newPoints.toLocaleString('id-ID')}</span>
                        </div>`;
                }

                li.innerHTML = `
                    <div class="flex justify-between items-start mb-1 gap-2">
                        <span class="text-xs md:text-sm font-semibold text-slate-800 break-words">${log.admin}</span>
                        <span class="text-[10px] md:text-xs text-slate-400 shrink-0 text-right">${log.timestamp}</span>
                    </div>
                    <p class="text-xs md:text-sm text-slate-600 mb-2">
                        ${log.action} <span class="font-medium text-slate-800">${log.targetUser !== 'Sistem' ? log.targetUser : ''}</span>
                    </p>
                    ${pointsChange}
                `;
                container.appendChild(li);
            });
        }

        // --- MANAGE MODE ---
        document.getElementById('toggle-manage-btn').addEventListener('click', () => {
            isManageMode = !isManageMode;
            renderApp();
        });

        // --- EDIT NAMA ADMIN ---
        const textAdmin = document.getElementById('current-admin-text');
        const editAdminContainer = document.getElementById('admin-edit-container');
        const textAdminContainer = document.getElementById('admin-display-container');
        const adminInput = document.getElementById('admin-input');

        textAdmin.addEventListener('click', () => {
            adminInput.value = currentAdmin;
            textAdminContainer.classList.add('hidden');
            editAdminContainer.classList.remove('hidden');
            editAdminContainer.classList.add('flex');
            adminInput.focus();
        });

        const saveAdmin = () => {
            const newAdmin = adminInput.value.trim() || "Admin Utama";
            editAdminContainer.classList.add('hidden');
            editAdminContainer.classList.remove('flex');
            textAdminContainer.classList.remove('hidden');
            if (newAdmin !== currentAdmin) {
                updateData(users, logs, newAdmin);
            }
        };

        document.getElementById('save-admin-btn').addEventListener('click', saveAdmin);
        document.getElementById('cancel-admin-btn').addEventListener('click', () => {
            editAdminContainer.classList.add('hidden');
            editAdminContainer.classList.remove('flex');
            textAdminContainer.classList.remove('hidden');
        });
        adminInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveAdmin(); });

        // --- EDIT POIN CEPAT (INLINE) ---
        window.openInlinePoints = (id, value) => {
            inlinePointEditId = id;
            inlinePointEditValue = value;
            renderApp();
        };
        window.cancelInlinePoints = () => {
            inlinePointEditId = null;
            renderApp();
        };
        window.saveInlinePoints = (id) => {
            const input = document.getElementById(`inline-point-input-${id}`);
            const parsed = parseInt(input.value, 10);
            if (isNaN(parsed) || parsed < 0) return alert("Poin tidak valid!");
            
            const user = users.find(u => u.id === id);
            
            inlinePointEditId = null; // Tutup mode input
            
            if (parsed !== user.points) {
                const newLog = { id: Date.now(), timestamp: new Date().toLocaleString('id-ID'), admin: currentAdmin, targetUser: user.name, action: 'Edit Poin', oldPoints: user.points, newPoints: parsed };
                
                const isToday = user.editedDate === new Date().toDateString();
                const newEditCount = isToday ? (user.editCountToday || 0) + 1 : 1;
                
                const updatedUser = { ...user, points: parsed, editedDate: new Date().toDateString(), editCountToday: newEditCount };
                const otherUsers = users.filter(u => u.id !== id);
                
                updateData([...otherUsers, updatedUser], [newLog, ...logs]); // Render dipanggil di sini
            } else {
                renderApp(); // Render jika batal/tidak berubah
            }
        };
        
        // Listener Enter untuk Edit Poin & Bonus Cepat
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (inlinePointEditId && e.target.id === `inline-point-input-${inlinePointEditId}`) saveInlinePoints(inlinePointEditId);
                if (inlineBonusEditId && e.target.id === `inline-bonus-input-${inlineBonusEditId}`) saveInlineBonus(inlineBonusEditId);
            }
        });

        // --- EDIT BONUS CEPAT (INLINE) ---
        window.openInlineBonus = (id, value) => {
            inlineBonusEditId = id;
            inlineBonusEditValue = value;
            renderApp();
        };
        window.cancelInlineBonus = () => {
            inlineBonusEditId = null;
            renderApp();
        };
        window.saveInlineBonus = (id) => {
            const input = document.getElementById(`inline-bonus-input-${id}`);
            const parsed = parseInt(input.value, 10) || 0;
            if (parsed < 0) return alert("Bonus tidak valid!");
            
            const user = users.find(u => u.id === id);
            const currentBonus = user.bonus || 0;
            
            inlineBonusEditId = null; // Tutup mode input

            if (parsed !== currentBonus) {
                const newLog = { id: Date.now(), timestamp: new Date().toLocaleString('id-ID'), admin: currentAdmin, targetUser: user.name, action: 'Edit Bonus', oldPoints: currentBonus, newPoints: parsed };
                
                const isToday = user.editedDate === new Date().toDateString();
                const newEditCount = isToday ? (user.editCountToday || 0) + 1 : 1;
                
                const updatedUser = { ...user, bonus: parsed, editedDate: new Date().toDateString(), editCountToday: newEditCount };
                const otherUsers = users.filter(u => u.id !== id);
                
                updateData([...otherUsers, updatedUser], [newLog, ...logs]); // Render dipanggil di sini
            } else {
                renderApp(); // Render jika batal/tidak berubah
            }
        };

        // --- FUNGSI DRAG AND DROP (URUTKAN) ---
        function handleSort() {
            if (dragItemIndex !== null && dragOverItemIndex !== null && dragItemIndex !== dragOverItemIndex) {
                let _users = [...users];
                const draggedItem = _users.splice(dragItemIndex, 1)[0];
                _users.splice(dragOverItemIndex, 0, draggedItem);
                
                const newLog = { id: Date.now(), timestamp: new Date().toLocaleString('id-ID'), admin: currentAdmin, targetUser: draggedItem.name, action: 'Menggeser urutan akun', oldPoints: 0, newPoints: 0 };
                updateData(_users, [newLog, ...logs]);
            }
            dragItemIndex = null;
            dragOverItemIndex = null;
        }

        // --- MODAL TAMBAH PENGGUNA ---
        const addModal = document.getElementById('add-modal');
        document.getElementById('add-user-btn').addEventListener('click', () => {
            // Bersihkan form setiap kali dibuka
            document.getElementById('add-name').value = '';
            document.getElementById('add-email').value = '';
            document.getElementById('add-points').value = '0';
            document.getElementById('add-bonus').value = '0';
            document.getElementById('add-role').value = 'Pengguna';
            addModal.classList.remove('hidden');
        });
        document.getElementById('close-add-modal').addEventListener('click', () => addModal.classList.add('hidden'));
        document.getElementById('cancel-add-modal').addEventListener('click', () => addModal.classList.add('hidden'));
        document.getElementById('save-add-modal').addEventListener('click', () => {
            const name = document.getElementById('add-name').value.trim();
            const email = document.getElementById('add-email').value.trim();
            const points = parseInt(document.getElementById('add-points').value, 10) || 0;
            const bonus = parseInt(document.getElementById('add-bonus').value, 10) || 0;
            const role = document.getElementById('add-role').value.trim() || 'Pengguna';

            if (!name || !email) return alert("Nama dan Email wajib diisi!");
            if (points < 0 || bonus < 0) return alert("Poin dan Bonus tidak boleh bernilai negatif!");
            
            const newUser = { id: Date.now(), name, email, points, bonus, role };
            const newLog = { id: Date.now()+1, timestamp: new Date().toLocaleString('id-ID'), admin: currentAdmin, targetUser: name, action: 'Tambah Akun Baru', oldPoints: 0, newPoints: points };
            
            updateData([...users, newUser], [newLog, ...logs]);
            addModal.classList.add('hidden');
        });

        // --- MODAL PENGATURAN (EDIT) PENGGUNA ---
        const editModal = document.getElementById('edit-modal');
        window.openEditModal = (id) => {
            const user = users.find(u => u.id === id);
            if (!user) return;
            document.getElementById('edit-id').value = user.id;
            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-points').value = user.points;
            document.getElementById('edit-bonus').value = user.bonus || 0;
            document.getElementById('edit-role').value = user.role || '';
            editModal.classList.remove('hidden');
        };
        document.getElementById('close-edit-modal').addEventListener('click', () => editModal.classList.add('hidden'));
        document.getElementById('cancel-edit-modal').addEventListener('click', () => editModal.classList.add('hidden'));
        document.getElementById('save-edit-modal').addEventListener('click', () => {
            const id = parseInt(document.getElementById('edit-id').value, 10);
            const name = document.getElementById('edit-name').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const points = parseInt(document.getElementById('edit-points').value, 10) || 0;
            const bonus = parseInt(document.getElementById('edit-bonus').value, 10) || 0;
            const role = document.getElementById('edit-role').value.trim() || 'Pengguna';

            if (!name || !email) return alert("Nama dan Email wajib diisi!");
            if (points < 0 || bonus < 0) return alert("Poin dan Bonus tidak boleh negatif!");

            const user = users.find(u => u.id === id);
            let newLogs = logs;
            const currentBonus = user.bonus || 0;

            if (points !== user.points || bonus !== currentBonus || name !== user.name || role !== user.role) {
                const newLog = { id: Date.now(), timestamp: new Date().toLocaleString('id-ID'), admin: currentAdmin, targetUser: name, action: 'Ubah Pengaturan Akun', oldPoints: user.points, newPoints: points };
                newLogs = [newLog, ...logs];
            }

            const isToday = user.editedDate === new Date().toDateString();
            const newEditCount = isToday ? (user.editCountToday || 0) + 1 : 1;
            const updatedUser = { ...user, name, email, points, bonus, role, editedDate: new Date().toDateString(), editCountToday: newEditCount };
            const otherUsers = users.filter(u => u.id !== id);
            
            updateData([...otherUsers, updatedUser], newLogs);
            editModal.classList.add('hidden');
        });

        // --- HAPUS PENGGUNA ---
        const deleteModal = document.getElementById('delete-modal');
        document.getElementById('delete-user-trigger').addEventListener('click', () => {
            userToDeleteId = parseInt(document.getElementById('edit-id').value, 10);
            const user = users.find(u => u.id === userToDeleteId);
            document.getElementById('delete-user-name').textContent = user.name;
            editModal.classList.add('hidden');
            deleteModal.classList.remove('hidden');
        });
        document.getElementById('cancel-delete-modal').addEventListener('click', () => deleteModal.classList.add('hidden'));
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            const user = users.find(u => u.id === userToDeleteId);
            const newLog = { id: Date.now(), timestamp: new Date().toLocaleString('id-ID'), admin: currentAdmin, targetUser: user.name, action: 'Hapus Akun', oldPoints: user.points, newPoints: 0 };
            
            const newUsers = users.filter(u => u.id !== userToDeleteId);
            updateData(newUsers, [newLog, ...logs]);
            deleteModal.classList.add('hidden');
        });

        // --- BACKUP & RESTORE DATA KE/DARI KOMPUTER ---
        document.getElementById('backup-btn').addEventListener('click', () => {
            const dataToSave = { users, logs, currentAdmin };
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Backup-Rewards-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('file-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const parsedData = JSON.parse(event.target.result);
                    if (parsedData.users && parsedData.logs) {
                        updateData(parsedData.users, parsedData.logs, parsedData.currentAdmin || currentAdmin);
                        alert("Data berhasil dipulihkan!");
                    } else {
                        alert("Format file backup tidak valid!");
                    }
                } catch (error) {
                    alert("Gagal membaca file backup.");
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset input
        });

        // Tampilkan awal! Bahkan jika Firebase belum selesai di-load.
        renderApp();
    </script>
</body>
</html>
